<title>wasm-judge</title>
<body>

Enter a WebAssembly file to judge:
<br>
<input type="file"
       id="the_input"
       accept="application/wasm" oninput="processInput()">
<hr>
<textarea id="the_output" rows=3 cols=100></textarea>

<script>
var theInput = document.getElementById('the_input');
theInput.value = '';

var theOutput = document.getElementById('the_output');
theOutput.value = '';

var worker = new Worker('judge.worker.js');

function sendJob(wasm) {
  theOutput.value = 'Optimizing...';
  var oldSize = wasm.length;
  worker.onmessage = (message) => {
    var newSize = message.data.size;
    var missedOpportunity = 1 - newSize / oldSize;
    if (missedOpportunity > 0.01) {
      text = 'Should have ran wasm-opt, could have saved ' +
        Number(100 * missedOpportunity).toFixed(2) + '%.';
    } else {
      text = 'Looks good!';
    }
    theOutput.value = text;
  };
  worker.postMessage({
    wasm: wasm
  });
}

function processInput(message) {
  var file = theInput.files[0];
  const objectURL = window.URL.createObjectURL(file);
  fetch(objectURL)
    .then(response => response.arrayBuffer())
    .then(buffer => {
      var data = new Uint8Array(buffer);
      sendJob(data);
      window.URL.revokeObjectURL(objectURL);
    });
}
</script>

</body>
