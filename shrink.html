<title>wasm-shrink</title>
<body>

<h1>wasm-shrink: Constructive Criticism for WebAssembly Binaries</h1>

Provide a WebAssembly file:
<input type="file"
       id="file_input"
       style="color: transparent"
       accept="application/wasm"
       oninput="processFile(fileInput.files[0])">
<br>
Or enter a URL (will fail without CORS; for a test, try "opt.wasm" or "unopt.wasm"):
<input type="text"
       id="url_input"
       onkeypress="return onURLKeypress(event)">
<input type="submit" value="Read URL" onclick="processURL(urlInput.value)">

<br><br>

<div id="the_output" style="border: 0.1em solid black; background-color: #eee"></div>

<br><br>

<small>(This runs <a href="https://github.com/WebAssembly/binaryen/#wasm-opt">Binaryen's wasm-opt</a> on this page; there is no server component. TODO: CSS, use multiple cores for speed - large files may be slow for now)</small>

<script>
var fileInput = document.getElementById('file_input');
fileInput.value = '';

var urlInput = document.getElementById('url_input');
urlInput.value = '';

var theOutput = document.getElementById('the_output');

function onURLKeypress(event) {
  if (event.keyCode == 13) {
    processURL(urlInput.value);
    return false;
  }
  return true;
}

function output(child) {
  theOutput.appendChild(
    typeof child === 'string' ? document.createTextNode(child) : child
  );
  theOutput.appendChild(
    document.createElement('div')
  );
}

var worker = new Worker('shrink.worker.js');

function reportResults(name, results) {
  var oldSize = results.oldSize;
  var optSize = results.optSize;
  var convergeSize = results.convergeSize;
  if (convergeSize < optSize) {
    name += ' --converge';
    optSize = convergeSize;
  }
  var missedOpportunity = 100 * (1 - optSize / oldSize);
  var canHelp = missedOpportunity > 0.01;
  var text = 'wasm-opt ' + name;
  if (canHelp) {
    text += ' could have saved ' +
      Number(missedOpportunity).toFixed(2) + '%';
    for (var i = 0; i < Math.log2(missedOpportunity) - 1; i++) {
      text += '!';
    }
    if (text.indexOf('!') < 0) text += '.';
  } else {
    text += ' would not have helped, the binary looks good already.';
  }
  output(text);
  if (canHelp) {
    // Emit a download link for the new binary.
    const link = document.createElement('a');
    link.href = window.URL.createObjectURL(new Blob([results.newBinary])); // leak!
    link.appendChild(document.createTextNode('download'));
    link.download = 'optimized.wasm';
    output(link);
  }
  output(document.createElement('br'));
}

function sendJob(name, wasm) {
  worker.onmessage = (message) => {
    reportResults('-O', message.data);
  };
  worker.postMessage({
    wasm: wasm
  });
}

function processFile(file) {
  output('Processing file: ' + file.name);
  const objectURL = window.URL.createObjectURL(file);
  fetch(objectURL)
    .then(response => response.arrayBuffer())
    .then(buffer => {
      var data = new Uint8Array(buffer);
      sendJob('-O', data);
      window.URL.revokeObjectURL(objectURL);
    });
}

function processURL(url) {
  output('Processing URL: ' + url);
  fetch(url)
    .then(response => response.arrayBuffer())
    .then(buffer => {
      var data = new Uint8Array(buffer);
      sendJob('-O', data);
    });
}

onerror = () => {
  output('A problem happened :( Check the dev console.');
};
</script>

</body>
