<title>wasm-shrink</title>
<head>
  <!-- the style is borrowed from Massive, https://github.com/kripken/Massive -->
  <link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,700" rel="stylesheet" type="text/css">
  <link href="style/main.css" rel="stylesheet">
</head>

<body>
  <header class="header">
    <div class="wrap flex">
      <a href="" class="logo flex flex-1">
        <big class="massive flex vcentre">wasm-shrink</big>
      </a>
      <nav class="flex">
        <a href="#faq" class="flex vcentre">FAQ</a>
        <a href="https://github.com/WebAssembly/binaryen/" class="flex vcentre">Source Code</a>
        <a href="https://docs.google.com/presentation/d/1EOpX47PszpuYOtkFc5XzDiWEPelH1e-LARsOZ4Ax-0w/edit?ts=5e38b7e2#slide=id.gc6f9e470d_0_0" class="flex vcentre">Background Slides</a>
      </nav>
    </div>
  </header>

  <masthead id="intro" class="masthead-intro">
    <div class="wrap wrap-juicy wrap-dark">
      <big class="slogan">Constructive Criticism for <a href="https://webassembly.org/">WebAssembly</a> Binaries</big>
    </div>
  </masthead>

  <section id="benchmarks" class="benchmarks">
    <div class="wrap wrap-juicy wrap-light wrap-centre">
      <b>Pick a WebAssembly file</b>:
      <input type="file" class="btn btn-cta btn-run"
             id="file_input"
             style="color: transparent"
             accept="application/wasm"
             oninput="processFile(fileInput.files[0])">
      <br><br>
      <b>Or enter a URL of a WebAssembly file</b> (will fail without CORS; for a test, try "opt.wasm" or "unopt.wasm"):
      <input type="text" class="btn btn-cta btn-"
             id="url_input"
             onkeypress="return onURLKeypress(event)">
    </div>
  </section>

  <section id="benchmarks" class="benchmarks">
    <div class="wrap wrap-juicy wrap-light wrap-centre">
      <h3>Output</h3>
      <br><hr><br>
      <code id="the_output"></code>
      <hr><br>
    </div>
  </section>

  <br>
  <br>

  <section id="faq" class="faq">
    <div class="wrap wrap-juicy prose">
      <h2>FAQ</h2>
      <h3 class="section-heading"><a aria-hidden="true" class="section-anchor">What does this do?</a></h3>
      <div class="answer">
        <p>
          When given a WebAssembly file, this site will try to shrink it down to a smaller size. It
          will report whether it succeeded, and if so, will let you download that optimized binary.
        </p>
      </div>
      <h3 class="section-heading"><a aria-hidden="true" class="section-anchor">How does this work?</a></h3>
      <div class="answer">
        <p>
          This runs <a href="https://github.com/WebAssembly/binaryen/#wasm-opt">Binaryen's wasm-opt</a>
          tool. wasm-opt has many optimizations that can improve WebAssembly files' size and speed.
        </p>
        <p>
          Note that there is no server component! Everything here runs on the client, right here on the page.
        </p>
      </div>
      <h3 class="section-heading"><a aria-hidden="true" class="section-anchor">Are there any known issues?</a></h3>
      <div class="answer">
        <p>
          This currently uses only a single core. On large wasm files that may be slow, in which case, please
          use wasm-opt <a href="https://docs.google.com/presentation/d/1EOpX47PszpuYOtkFc5XzDiWEPelH1e-LARsOZ4Ax-0w/edit?ts=5e38b7e2#slide=id.g6e4f40de0f_0_38">locally</a>,
          which can scale to use as many cores as you have.
        </p>
      </div>
    </div>
  </section>

  <footer id="footer" class="footer">
    <div class="wrap wrap-juicy">
      <p>v0.0.1</p>
    </div>
  </footer>

<script>
var fileInput = document.getElementById('file_input');
fileInput.value = '';

var urlInput = document.getElementById('url_input');
urlInput.value = '';

var theOutput = document.getElementById('the_output');

function onURLKeypress(event) {
  if (event.keyCode == 13) {
    processURL(urlInput.value);
    return false;
  }
  return true;
}

function output(child) {
  theOutput.appendChild(
    typeof child === 'string' ? document.createTextNode(child) : child
  );
  theOutput.appendChild(
    document.createElement('div')
  );
}

var worker = new Worker('shrink.worker.js');

function reportResults(name, results) {
  var oldSize = results.oldSize;
  var optSize = results.optSize;
  var convergeSize = results.convergeSize;
  if (convergeSize < optSize) {
    name += ' --converge';
    optSize = convergeSize;
  }
  var missedOpportunity = 100 * (1 - optSize / oldSize);
  var canHelp = missedOpportunity > 0.01;
  var text = 'wasm-opt ' + name;
  if (canHelp) {
    text += ' could have saved ' +
      Number(missedOpportunity).toFixed(2) + '%';
    for (var i = 0; i < Math.log2(missedOpportunity) - 1; i++) {
      text += '!';
    }
    if (text.indexOf('!') < 0) text += '.';
  } else {
    text += ' would not have helped, the binary looks good already.';
  }
  output(text);
  if (canHelp) {
    // Emit a download link for the new binary.
    const link = document.createElement('a');
    link.href = window.URL.createObjectURL(new Blob([results.newBinary])); // leak!
    link.appendChild(document.createTextNode('download'));
    link.download = 'optimized.wasm';
    link.className = 'btn btn-paste';
    output(link);
  }
  output(document.createElement('br'));
}

function sendJob(name, wasm) {
  worker.onmessage = (message) => {
    reportResults('-O', message.data);
  };
  worker.postMessage({
    wasm: wasm
  });
}

function processFile(file) {
  output('Processing file: ' + file.name);
  const objectURL = window.URL.createObjectURL(file);
  fetch(objectURL)
    .then(response => response.arrayBuffer())
    .then(buffer => {
      var data = new Uint8Array(buffer);
      sendJob('-O', data);
      window.URL.revokeObjectURL(objectURL);
    });
}

function processURL(url) {
  output('Processing URL: ' + url);
  fetch(url)
    .then(response => response.arrayBuffer())
    .then(buffer => {
      var data = new Uint8Array(buffer);
      sendJob('-O', data);
    });
}

onerror = () => {
  output('A problem happened :( Check the dev console.');
};
</script>

</body>
