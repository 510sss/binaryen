<title>wasm-critic</title>
<body>

<h1>Constructive Criticism for WebAssembly Binaries</h1>

<table>
<tr>
<td>
  Enter a WebAssembly file to examine:
  <br>
  <input type="file"
         id="file_input"
         accept="application/wasm" oninput="processFile(fileInput.files[0])">
</td>
<td width=100></td>
<td>
  Or enter a URL (will fail without CORS):
  <br>
  <input type="text"
         id="url_input">
  <input type="submit" value="Read URL" onclick="processURL(urlInput.value)">
</td>
</tr>
</table>

<hr>

<textarea id="the_output" rows=10 cols=100></textarea>

<script>
var fileInput = document.getElementById('file_input');
fileInput.value = '';

var urlInput = document.getElementById('url_input');
urlInput.value = '';

var theOutput = document.getElementById('the_output');
theOutput.value = '';

function output(text) {
  if (theOutput.value) theOutput.value += '\n';
  theOutput.value += text;
}

var worker = new Worker('critic.worker.js');

function reportResults(name, results) {
  var oldSize = results.oldSize;
  var optSize = results.optSize;
  var convergeSize = results.convergeSize;
  if (convergeSize < optSize) {
    name += ' --converge';
    optSize = convergeSize;
  }
  var missedOpportunity = 100 * (1 - optSize / oldSize);
  var text = 'wasm-opt ' + name;
  if (missedOpportunity > 0.01) {
    text += ' could have saved ' +
      Number(missedOpportunity).toFixed(2) + '%';
    for (var i = 0; i < Math.log2(missedOpportunity) - 1; i++) {
      text += '!';
    }
    if (text.indexOf('!') < 0) text += '.';
  } else {
    text += ' would not have helped, the binary looks good already.';
  }
  output(text);
}

function sendJob(name, wasm) {
  output('Processing "' + name + '...');
  worker.onmessage = (message) => {
    output('... "' + name + '" complete.');
    reportResults('-O', message.data);
  };
  worker.postMessage({
    wasm: wasm
  });
}

function processFile(file) {
  const objectURL = window.URL.createObjectURL(file);
  fetch(objectURL)
    .then(response => response.arrayBuffer())
    .then(buffer => {
      var data = new Uint8Array(buffer);
      sendJob('-O', data);
      window.URL.revokeObjectURL(objectURL);
    });
}

function processURL(url) {
  fetch(url)
    .then(response => response.arrayBuffer())
    .then(buffer => {
      var data = new Uint8Array(buffer);
      sendJob('-O', data);
    });
}
</script>

</body>
